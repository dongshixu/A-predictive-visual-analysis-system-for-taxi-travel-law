// JavaScript Document
(function($) {
    var isAction = true;
    var width = 0;
    var thewidth = 0;
    var CurrTime = 0;
    var t;
    var addHour = 0,
        addMinute = 0,
        addSecond = 0,
        TheHour = 0,
        TheMinute = 0,
        TheSecond = 0;
    var flag = 0;
    var alltime = 0;
    var addwidth = 0;
    var offsetW = 0;
    var times = 0;
    var rwidth = 0;
    var nowtime, endtime, lasttime=0;
    jQuery.playBar = {
        addBar: function(DOM, allTime, nowtime, endtime) {
            CleanAll();
            alltime = allTime;
            nowtime = nowtime;
            endtime = endtime;
            DOM.empty();
            DOM.append("<div class='BarControl'></div>");
            $(".BarControl").append('<div class="TheBar"><div class="TimeBall"></div><div class="TheColorBar"></div></div><div class="BarBeginTime">'+nowtime+'</div><span class = "sp">/</span><div class="BarFinishTime">'+endtime+'</div>');
            width = $('.TheBar').width();
            times = allTime;
            rwidth = width - 8;
            addwidth = (width - 10) / times;
            var t = TransitionTime(allTime, nowtime, endtime);
            $('.BarFinishTime').html(t.end);
            OpenBar()
        },
        restTime: function(allTime, nowtime, endtime) {
            CleanAll();
            StopBar();
            alltime = allTime;
            width = $('.TheBar').width();
            times = allTime;
            rwidth = width - 8;
            addwidth = (width - 10) / times;
            var t = TransitionTime(allTime, nowtime, endtime);
            $('.BarFinishTime').html(t.end);
            $('.TheColorBar').css("width", 0);
            $('.TimeBall').css("left", 0);
            StopBar()
        },
        Stop: function() {
            StopBar()
        },
        Begin: function() {
            OpenBar()
        },
        changeBarColor: function(COLOR) {
            var color = typeof(COLOR) != "undefined" ? COLOR : '#3498DB';
            $('.TheColorBar').css("background", color);
            $('.TimeBall').css("background", "white")
        },
        changeFontColor: function(COLOR) {
            var color = typeof(COLOR) != "undefined" ? COLOR : '#3498DB';
            $('.BarBeginTime,.BarFinishTime').css("color", color)
        },
        getTheTime: function() {
            return CurrTime
        },
        clean: function(){
        	return CleanAll();
        }
    };

    function CleanAll() {
        isAction = true;
        thewidth = 0;
        CurrTime = 0;
        addHour = 0;
        addMinute = 0;
        addSecond = 0;
        TheHour = 0;
        TheMinute = 0;
        TheSecond = 0;
        offsetW = 0;
        thewidth = 0;
        flag = 0
    }
    var down = false;
    var BarMove = false;
    var lastX = 0,
        NewX = 0;
    $(document).on("mousedown", '.TimeBall', function(event) {
        lastX = event.clientX;
        event.preventDefault();
        down = true;
        BarMove = true;
        if (isAction) {
            StopBar()
        }
    });
    $(document).mousemove(function(event) {
        event.preventDefault();
        NewX = event.clientX;
        if (BarMove) {
            var mcs = NewX - lastX;
            lastX = NewX;
            if (mcs < 0) {
                if (thewidth - (-mcs) > 0) {
                    thewidth = thewidth - (-mcs)
                }
            } else {
                if (thewidth + mcs < rwidth) {
                    thewidth = thewidth + mcs
                } else {
                    thewidth = rwidth
                }
            }
            timechange();
            $('.TheColorBar').css("width", thewidth + 1);
            $('.TimeBall').css("left", thewidth)
            var dt = $(".D3").val()
		  	var a = dt.substring(5,7)
		  	var d = a;
		  	var b = dt.substring(8,10)
		  	var c = dt.substring(2,4)
		  	a = a + b;
		  	var d1 = c + '/' + d + '/' + b;
            var left = $(".TimeBall").position().left+143.5;
			left = left + "px";
			$("#pop").css("left",left);
			var p = $(".BarBeginTime").html();
			$("#pop2").html(d1 + '<br/>' + p)
        }
    });
    $(document).mouseup(function() {
        if (BarMove) {
            BarMove = false;
            down = false;
            NewX = 0;
            var xo = parseInt(CurrTime);
            offsetW = thewidth - xo * addwidth;
            if (isAction) {
                OpenBar()
            }
        }
    });

    function timechange() {
        CurrTime = parseInt(thewidth / rwidth * alltime);
        console.log(CurrTime)
        var minute, hour;
        var ltx = TransitionTime(CurrTime, nowtime, endtime);
        hour = parseInt($('#time1').val().substring(0, 2))
        minute = parseInt($('#time1').val().substring(3, 5))
        if (thewidth < rwidth && CurrTime < alltime) {
        		minute = minute + CurrTime;
	            if (minute > 59) {
	                minute = 0;
	                hour = hour + 1
	            }
	            if (minute > 9) {
	                minute = "" + minute
	            } else {
	                minute = "0" + minute
	            } if (hour > 9) {
	                hour = "" + hour
	            } else {
	                hour = "0" + hour
	            }
            $('.BarBeginTime').html(hour + ":" + minute)
        } else {
        	action = true;
			$("#i3").removeClass("fa-pause").addClass("fa-play").attr("title", "Play").css("left", "1.5px");
            thewidth = rwidth;
            StopBar()
        }
        lasttime = CurrTime
//      if (TheHour > 0) {
//          if (ltx.hHour) {
//              $('.BarBeginTime').html(ltx.StringTime)
//          } else {
//              $('.BarBeginTime').html("00:" + ltx.StringTime)
//          }
//      } else {
//          $('.BarBeginTime').html(ltx.StringTime)
//      }
//      addSecond = ltx.Tsec;
//      addMinute = ltx.Tmin;
//      addHour = ltx.Thour
    }

    function changeBar() {
        var minute, hour;
        hour = parseInt($('.BarBeginTime').html().substring(0, 2))
        minute = parseInt($('.BarBeginTime').html().substring(3, 5))
        thewidth = thewidth * 1 + addwidth - offsetW;
//      console.log(thewidth, addwidth,offsetW, rwidth)
        if (offsetW > 0) {
            offsetW = 0
        }
        timechange() 
        if (thewidth < rwidth && CurrTime < alltime) {
            CurrTime = CurrTime;
//          console.log(CurrTime)
            minute = minute + 1;
            if (minute > 59) {
                minute = 0;
                hour = hour + 1
            }
            if (minute > 9) {
                minute = "" + minute
            } else {
                minute = "0" + minute
            } if (hour > 9) {
                hour = "" + hour
            } else {
                hour = "0" + hour
            } if (addHour > 0) {
                flag = 1
            }
            if (flag == 0) {
                $('.BarBeginTime').html(hour + ":" + minute)
            } else {
                $('.BarBeginTime').html(hour + ":" + minute)
            }
        } else {
        	action = true;
        	$("#i3").removeClass("fa-pause").addClass("fa-play").attr("title", "Play").css("left", "1.5px");
            thewidth = rwidth;
            StopBar()
        }
        $('.TheColorBar').css("width", thewidth + 1);
        $('.TimeBall').css("left", thewidth)
//      console.log($("#pop").position().left)
    }

    function TransitionTime(str, nowtime, endtime) {
        var m = parseFloat(str);
        var time = "";
        var second, minute, hour;
        var haveHour = false;
        var ch = 0,
            csx = 0,
            cm = 0;
        if (m >= 0 && m < 60) {
            if (parseInt(m / 60.0) < 10) {
                minute = "0" + parseInt(m / 60.0)
            } else {
                minute = parseInt(m / 60.0)
            }
            TheMinute = parseInt(m / 60.0);
            cm = TheMinute;
            TheHour = 0;
            time = endtime
            time1 = endtime
        } else if (m >= 60) {
            flag = 1;
            haveHour = true;
            ch = parseInt(m / 60.0);
            cm = m-parseInt(m / 60.0);
            TheHour = ch;
            TheMinute = cm;
			time = endtime
			time1 = endtime
        } 
        var tt = {
            hHour: haveHour,
            Thour: ch,
            Tmin: cm,
            Tsec: csx,
            StringTime: time,
            end: time1
        };
        return tt
    }

    function StopBar() {
        if (!down) {
            isAction = false
        }
        clearInterval(t)
    }

    function OpenBar() {
        isAction = true;
        t = setInterval(changeBar, 1000)
    }
})(jQuery);